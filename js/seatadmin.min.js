/*! learn-canvas - v0.0.0 2013-12-17 
 Copyright (c) 2013 AndyYou Licensed  */ 
var mousewheel=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel",padding=[10,10,10,10],stageWidth=480,stageHeight=320,seatWidth=20,seatHeight=20,seatRadius=6,seatRow=10,seatColumn=24,seatTotalWidth=seatWidth*seatColumn,seatTotalHeight=seatHeight*seatRow,seatsConfig=[],seatsUnconfigColor="0,0,0,0.2",seatsUnconfigHighlight="0,100,0,0.8",defaultScale=seatTotalWidth>=seatTotalHeight?stageWidth/seatTotalWidth*.9:stageHeight/seatTotalHeight*.9,scale=defaultScale,defaultOffsetX=(stageWidth-seatTotalWidth*defaultScale)/2,minScale=.25,maxScale=2.5,hoverSeatId="",isSelecting=!1,isSelectBoxExists=!1,isSelectBoxDrawing=!1,rectSelectBox=null,rectSelectInitX=0,rectSelectnitY=0,rectSelectFill="rgba(0,0,0,0.2)",rectSelectStroke="transparent",highlightFill="rgba(0,0,0,0.3)",highlightStroke="rgba(99,202,252,1)",highlightStrokeWidth=2,stage=new Kinetic.Stage({container:"container",width:stageWidth,height:stageHeight,draggable:!1}),layer=new Kinetic.Layer({scale:defaultScale,x:defaultOffsetX}),layerSelection=new Kinetic.Layer,layerTooltip=new Kinetic.Layer,rectBackground=new Kinetic.Rect({x:0,y:0,width:stage.getWidth(),height:stage.getHeight(),fill:"transparent",draggable:!1,name:"background"});rectBackground.on("mousedown",function(e){e.shiftKey||(isSelecting=!0)}),layerSelection.add(rectBackground);var rectArena=new Kinetic.Rect({x:padding[1],y:stage.getHeight()-80-padding[2],width:seatTotalWidth-padding[1]-padding[3],height:80,fill:"rgba(0, 0, 0, 0.1)",cornerRadius:5}),txtArena=new Kinetic.Text({x:stage.getWidth()/2,y:stage.getHeight()/3*2+50,text:"表演區域",fontSize:20,fill:"rgba(0, 0, 0, 0.3)"});txtArena.setOffset({x:txtArena.getWidth()/2}),layer.add(rectArena),layer.add(txtArena),layer.on("mousedown",function(e){e.shiftKey||(isSelecting=!0)});for(var seats=[{x:150,y:10,id:"10-1"},{x:170,y:10,id:"10-2"},{x:190,y:10,id:"10-3"},{x:210,y:10,id:"10-4"},{x:230,y:10,id:"10-5"},{x:250,y:10,id:"10-6"},{x:270,y:10,id:"10-7"},{x:290,y:10,id:"10-8"},{x:310,y:10,id:"10-9"},{x:330,y:10,id:"10-10"},{x:10,y:30,id:"9-1"},{x:30,y:30,id:"9-2"},{x:50,y:30,id:"9-3"},{x:70,y:30,id:"9-4"},{x:90,y:30,id:"9-5"},{x:150,y:30,id:"9-6"},{x:170,y:30,id:"9-7"},{x:190,y:30,id:"9-8"},{x:210,y:30,id:"9-9"},{x:230,y:30,id:"9-10"},{x:250,y:30,id:"9-11"},{x:270,y:30,id:"9-12"},{x:290,y:30,id:"9-13"},{x:310,y:30,id:"9-14"},{x:330,y:30,id:"9-15"},{x:390,y:30,id:"9-17"},{x:410,y:30,id:"9-18"},{x:430,y:30,id:"9-19"},{x:450,y:30,id:"9-20"},{x:470,y:30,id:"9-21"},{x:10,y:50,id:"8-1"},{x:30,y:50,id:"8-2"},{x:50,y:50,id:"8-3"},{x:70,y:50,id:"8-4"},{x:90,y:50,id:"8-5"},{x:150,y:50,id:"8-6"},{x:170,y:50,id:"8-7"},{x:190,y:50,id:"8-8"},{x:210,y:50,id:"8-9"},{x:230,y:50,id:"8-10"},{x:250,y:50,id:"8-11"},{x:270,y:50,id:"8-12"},{x:290,y:50,id:"8-13"},{x:310,y:50,id:"8-14"},{x:330,y:50,id:"8-15"},{x:390,y:50,id:"8-17"},{x:410,y:50,id:"8-18"},{x:430,y:50,id:"8-19"},{x:450,y:50,id:"8-20"},{x:470,y:50,id:"8-21"},{x:10,y:70,id:"7-1"},{x:30,y:70,id:"7-2"},{x:50,y:70,id:"7-3"},{x:70,y:70,id:"7-4"},{x:90,y:70,id:"7-5"},{x:150,y:70,id:"7-6"},{x:170,y:70,id:"7-7"},{x:190,y:70,id:"7-8"},{x:210,y:70,id:"7-9"},{x:230,y:70,id:"7-10"},{x:250,y:70,id:"7-11"},{x:270,y:70,id:"7-12"},{x:290,y:70,id:"7-13"},{x:310,y:70,id:"7-14"},{x:330,y:70,id:"7-15"},{x:390,y:70,id:"7-17"},{x:410,y:70,id:"7-18"},{x:430,y:70,id:"7-19"},{x:450,y:70,id:"7-20"},{x:470,y:70,id:"7-21"},{x:10,y:90,id:"6-1"},{x:30,y:90,id:"6-2"},{x:50,y:90,id:"6-3"},{x:70,y:90,id:"6-4"},{x:90,y:90,id:"6-5"},{x:150,y:90,id:"6-6"},{x:170,y:90,id:"6-7"},{x:190,y:90,id:"6-8"},{x:210,y:90,id:"6-9"},{x:230,y:90,id:"6-10"},{x:250,y:90,id:"6-11"},{x:270,y:90,id:"6-12"},{x:290,y:90,id:"6-13"},{x:310,y:90,id:"6-14"},{x:330,y:90,id:"6-15"},{x:390,y:90,id:"6-17"},{x:410,y:90,id:"6-18"},{x:430,y:90,id:"6-19"},{x:450,y:90,id:"6-20"},{x:470,y:90,id:"6-21"},{x:10,y:110,id:"5-1"},{x:30,y:110,id:"5-2"},{x:50,y:110,id:"5-3"},{x:70,y:110,id:"5-4"},{x:90,y:110,id:"5-5"},{x:150,y:110,id:"5-6"},{x:170,y:110,id:"5-7"},{x:190,y:110,id:"5-8"},{x:210,y:110,id:"5-9"},{x:230,y:110,id:"5-10"},{x:250,y:110,id:"5-11"},{x:270,y:110,id:"5-12"},{x:290,y:110,id:"5-13"},{x:310,y:110,id:"5-14"},{x:330,y:110,id:"5-15"},{x:390,y:110,id:"5-17"},{x:410,y:110,id:"5-18"},{x:430,y:110,id:"5-19"},{x:450,y:110,id:"5-20"},{x:470,y:110,id:"5-21"},{x:10,y:130,id:"4-1"},{x:30,y:130,id:"4-2"},{x:50,y:130,id:"4-3"},{x:70,y:130,id:"4-4"},{x:90,y:130,id:"4-5"},{x:150,y:130,id:"4-6"},{x:170,y:130,id:"4-7"},{x:190,y:130,id:"4-8"},{x:210,y:130,id:"4-9"},{x:230,y:130,id:"4-10"},{x:250,y:130,id:"4-11"},{x:270,y:130,id:"4-12"},{x:290,y:130,id:"4-13"},{x:310,y:130,id:"4-14"},{x:330,y:130,id:"4-15"},{x:390,y:130,id:"4-17"},{x:410,y:130,id:"4-18"},{x:430,y:130,id:"4-19"},{x:450,y:130,id:"4-20"},{x:470,y:130,id:"4-21"},{x:10,y:150,id:"3-1"},{x:30,y:150,id:"3-2"},{x:50,y:150,id:"3-3"},{x:70,y:150,id:"3-4"},{x:90,y:150,id:"3-5"},{x:150,y:150,id:"3-6"},{x:170,y:150,id:"3-7"},{x:190,y:150,id:"3-8"},{x:210,y:150,id:"3-9"},{x:230,y:150,id:"3-10"},{x:250,y:150,id:"3-11"},{x:270,y:150,id:"3-12"},{x:290,y:150,id:"3-13"},{x:310,y:150,id:"3-14"},{x:330,y:150,id:"3-15"},{x:390,y:150,id:"3-17"},{x:410,y:150,id:"3-18"},{x:430,y:150,id:"3-19"},{x:450,y:150,id:"3-20"},{x:470,y:150,id:"3-21"},{x:10,y:170,id:"2-1"},{x:30,y:170,id:"2-2"},{x:50,y:170,id:"2-3"},{x:70,y:170,id:"2-4"},{x:90,y:170,id:"2-5"},{x:150,y:170,id:"2-6"},{x:170,y:170,id:"2-7"},{x:190,y:170,id:"2-8"},{x:210,y:170,id:"2-9"},{x:230,y:170,id:"2-10"},{x:250,y:170,id:"2-11"},{x:270,y:170,id:"2-12"},{x:290,y:170,id:"2-13"},{x:310,y:170,id:"2-14"},{x:330,y:170,id:"2-15"},{x:390,y:170,id:"2-17"},{x:410,y:170,id:"2-18"},{x:430,y:170,id:"2-19"},{x:450,y:170,id:"2-20"},{x:470,y:170,id:"2-21"},{x:10,y:190,id:"1-1"},{x:30,y:190,id:"1-2"},{x:50,y:190,id:"1-3"},{x:70,y:190,id:"1-4"},{x:90,y:190,id:"1-5"},{x:150,y:190,id:"1-6"},{x:170,y:190,id:"1-7"},{x:190,y:190,id:"1-8"},{x:210,y:190,id:"1-9"},{x:230,y:190,id:"1-10"},{x:250,y:190,id:"1-11"},{x:270,y:190,id:"1-12"},{x:290,y:190,id:"1-13"},{x:310,y:190,id:"1-14"},{x:330,y:190,id:"1-15"},{x:390,y:190,id:"1-17"},{x:410,y:190,id:"1-18"},{x:430,y:190,id:"1-19"},{x:450,y:190,id:"1-20"},{x:470,y:190,id:"1-21"}],tickets=[{price:10,name:"保留位",sold:!1,color:"0, 0, 0, 0.8"},{price:100,name:"一般票",sold:!1,color:"0, 200, 0, 0.8"},{price:999,name:"貴賓票",sold:!1,color:"0, 0, 200, 0.8"}],i=0;i<seats.length;i++){var seat=new Kinetic.Circle({id:seats[i].id?seats[i].id:i.toString(),name:seats[i].name?seats[i].id:i.toString(),sold:seats[i].sold?seats[i].sold:!1,price:seats[i].price?seats[i].price:0,fill:seats[i].color?"rgba("+seats[i].color+")":"rgba("+seatsUnconfigColor+")",color:null,x:seats[i].x,y:seats[i].y+25,radius:seatRadius,checked:!1});seat.on("mouseover",function(){if(hoverSeatId=this.attrs.id,tooltip.setPosition(this.getAbsolutePosition().x,this.getAbsolutePosition().y),tooltip.getText().setText(this.attrs.id+"\n"+this.attrs.name+"\nNTD "+this.attrs.price),tooltip.show(),tooltip.getLayer().draw(),this.attrs.color){for(var rgba=this.attrs.color.split(","),i=0;i<rgba.length;i++)rgba[i]=parseInt(rgba[i]);rgba[3]=1;var masstone=rgba.indexOf(Math.max.apply(Math,rgba.slice(0,3)));rgba[masstone]=255,this.attrs.fill="rgba("+rgba.join(",")+")"}else this.attrs.fill="rgba("+seatsUnconfigHighlight+")";layer.batchDraw()}),seat.on("mouseout",function(){hoverSeatId="",tooltip.hide(),layerTooltip.batchDraw(),this.attrs.color?(this.attrs.fill="rgba("+this.attrs.color+")",this.attrs.stroke=null):this.attrs.fill="rgba("+seatsUnconfigColor+")",layer.batchDraw()}),layer.add(seat)}var tooltip=new Kinetic.Label({opacity:.75,visible:!1,listening:!1});tooltip.add(new Kinetic.Tag({fill:"black",pointerDirection:"down",pointerWidth:10,pointerHeight:10,lineJoin:"round",shadowOpacity:.5})),tooltip.add(new Kinetic.Text({text:"",fontFamily:"Calibri",fontSize:13,padding:5,fill:"white"})),layerTooltip.add(tooltip),stage.add(layerSelection),stage.add(layer),stage.add(layerTooltip),stage.getContainer().addEventListener("mousedown",function(e){if(!e.shiftKey&&seatsConfig.length>0){var name="";void 0!=e.shape&&(name=e.shape.attrs.name),void 0!=e.targetNode&&(name=e.targetNode.attrs.name);for(var seats=layer.get(".highlight");seats.length>0;)seats[0].remove(),seats=layer.get(".highlight");seatsConfig.length=0}}),stage.getContainer().addEventListener("mouseup",function(e){isSelecting&&(isSelecting=!1,GetOverlapped(e),null!=rectSelectBox&&rectSelectBox.remove(),rectSelectBox=null,isSelectBoxExists=!1),seatsConfig.length>0?$(".zoom-divider, .zoom-setting, .zoom-reset").removeClass("zoom-hidden"):($("#zoomSetting").addClass("zoom-hidden"),$("#zoomSetting").prev(".zoom-divider").addClass("zoom-hidden"),$("#zoomReset").addClass("zoom-hidden"),$("#zoomReset").prev(".zoom-divider").addClass("zoom-hidden")),layerSelection.draw(),layer.batchDraw()}),stage.getContainer().addEventListener("mousemove",function(e){isSelecting&&SetSelectionArea(e)}),document.attachEvent?stage.getContainer().attachEvent("on"+mousewheel,function(e){if(hoverSeatId){var seat=stage.find("#"+hoverSeatId)[0];tooltip.hide(),layerTooltip.draw(),seat.attrs.color?(seat.attrs.fill="rgba("+seat.attrs.color+")",seat.attrs.stroke=null):(seat.attrs.fill="rgba("+seatsUnconfigColor+")",seat.attrs.stroke=null)}Zoom(e)}):document.addEventListener&&stage.getContainer().addEventListener(mousewheel,function(e){if(hoverSeatId){var seat=stage.find("#"+hoverSeatId)[0];tooltip.hide(),layerTooltip.draw(),seat.attrs.color?(seat.attrs.fill="rgba("+seat.attrs.color+")",seat.attrs.stroke=null):(seat.attrs.fill="rgba("+seatsUnconfigColor+")",seat.attrs.stroke=null)}Zoom(e)});var SetSelectionArea=function(){if(isSelecting&&!isSelectBoxDrawing){isSelectBoxDrawing=!0;var mousePos=stage.getPointerPosition();if(mousePos){var x=mousePos.x?mousePos.x-stage.getAbsolutePosition().x:stage.getX()+stage.getWidth(),y=mousePos.y?mousePos.y-stage.getAbsolutePosition().y:stage.getY()+stage.getHeight();if(isSelectBoxExists){var height=0,width=0,newX=0,newY=0;newX=x>rectSelectInitX?rectSelectInitX:x,newY=y>rectSelectInitY?rectSelectInitY:y,height=Math.abs(Math.abs(y)-Math.abs(rectSelectInitY)),width=Math.abs(Math.abs(x)-Math.abs(rectSelectInitX)),rectSelectBox.setHeight(height),rectSelectBox.setWidth(width),rectSelectBox.setX(newX),rectSelectBox.setY(newY),layerSelection.batchDraw()}else rectSelectInitX=x,rectSelectInitY=y,rectSelectBox=new Kinetic.Rect({x:rectSelectInitX,y:rectSelectInitY,height:1,width:1,fill:rectSelectFill,stroke:rectSelectStroke}),layerSelection.add(rectSelectBox),layerSelection.draw(),isSelectBoxExists=!0}}isSelectBoxDrawing=!1},GetOverlapped=function(e){if(null==rectSelectBox)return GetOverlappedOnRectNull(e),void 0;seatsConfig.length=0,rectSelectInitX=0,rectSelectInitY=0;for(var seats=layer.find("Circle"),i=0;i<seats.length;i++){var seat=seats[i],pos=rectSelectBox.getAbsolutePosition(),startX=parseInt(pos.x-stage.getAbsolutePosition().x),endX=parseInt(pos.x-stage.getAbsolutePosition().x)+parseInt(rectSelectBox.getWidth()),startY=parseInt(pos.y-stage.getAbsolutePosition().y),endY=parseInt(pos.y-stage.getAbsolutePosition().y)+parseInt(rectSelectBox.getHeight()),seatStartX=parseInt(seat.getAbsolutePosition().x-seat.getRadius()),seatEndX=parseInt(seat.getAbsolutePosition().x)+parseInt(seat.getRadius()),seatStartY=parseInt(seat.getAbsolutePosition().y),seatEndY=parseInt(seat.getAbsolutePosition().y)+parseInt(seat.getRadius());if(seatStartX>=startX&&endX>=seatEndX&&seatStartY>=startY&&endY>=seatEndY&&seatsConfig.indexOf(seat.getId())<0){seatsConfig.push(seat.getId());var tmpX=parseInt(seat.getX()),tmpY=parseInt(seat.getY()),highlight=new Kinetic.Circle({x:tmpX,y:tmpY,radius:seatRadius,fill:highlightFill,stroke:highlightStroke,strokeWidth:highlightStrokeWidth,name:"highlight"});layer.add(highlight)}}},GetOverlappedOnRectNull=function(e){seatsConfig.length=0;var seat=e.targetNode;if(seatsConfig.indexOf(seat.getId())<0&&"Circle"==seat.getClassName()&&"highlight"!=seat.getName()){seatsConfig.push(seat.getId());var tmpX=parseInt(seat.getX()),tmpY=parseInt(seat.getY()),highlight=new Kinetic.Circle({x:tmpX,y:tmpY,radius:seatRadius,fill:highlightFill,stroke:highlightStroke,strokeWidth:highlightStrokeWidth,name:"highlight"});layer.add(highlight)}},Zoom=function(e){var e=window.event||e;delta=e.detail?-120*e.detail:e.wheelDelta,0!==delta&&(e.preventDefault?e.preventDefault():e.returnValue=!1);var nowScale;if(nowScale=delta>0?scale+Math.abs(delta/640):scale-Math.abs(delta/640),nowScale>minScale&&maxScale>nowScale){var dom=document.getElementById("container"),canvasPos=GetPosition(dom),pos=layer.getAbsolutePosition(),pageX=(layer.getAbsolutePosition(),0),pageY=0;e.pageX||e.pageY?(pageX=e.pageX,pageY=e.pageY):(e.clientX||e.clientY)&&(pageX=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,pageY=e.clientY+document.body.scrollTop+document.documentElement.scrollTop);var smallCalc=(stage.getPointerPosition(),(pageX-pos.x-canvasPos.x)/scale),smallCalcY=(pageY-pos.y-canvasPos.y)/scale,endCalc=pageX-canvasPos.x-nowScale*smallCalc,endCalcY=pageY-canvasPos.y-nowScale*smallCalcY;scale=nowScale,layer.setAbsolutePosition(endCalc,endCalcY),layer.setScale(nowScale),layer.batchDraw()}},GetPosition=function(el){for(var lx=0,ly=0;null!=el;lx+=el.offsetLeft,ly+=el.offsetTop,el=el.offsetParent);return{x:lx,y:ly}};$(function(){var anim;$("#zoomResize").click(function(){anim&&anim.isRunning()||(anim=new Kinetic.Animation(function(frame){var pos=layer.getAbsolutePosition();if(scale==defaultScale&&pos.x==defaultOffsetX&&0==pos.y)frame.time=0,this.stop();else{var frameOfLayer=(scale-defaultScale)*(frame.time/500);scale>defaultScale&&defaultScale>=scale-frameOfLayer||defaultScale>scale&&scale+frameOfLayer>=defaultScale?scale=defaultScale:scale-=frameOfLayer;var frameOfStageX=(pos.x-defaultOffsetX)*(frame.time/500),frameOfStageY=(pos.y-0)*(frame.time/500);frameOfStageX=pos.x>defaultOffsetX&&pos.x-frameOfStageX<=defaultOffsetX||pos.x<defaultOffsetX&&pos.x+frameOfStageX>=defaultOffsetX?defaultOffsetX:pos.x-frameOfStageX,frameOfStageY=pos.y>0&&pos.y-frameOfStageY<=0||pos.y<0&&pos.y+frameOfStageY>=0?0:pos.y-frameOfStageY,layer.setAbsolutePosition(frameOfStageX,frameOfStageY),layer.setScale(scale)}},layer),anim.start())}),$("#zoomIn").click(function(){if(!anim||!anim.isRunning()){var endScale=scale+.1875>=maxScale?maxScale:scale+.1875,widthScale=(1.1875*stage.getWidth()-stage.getWidth())/2,heightScale=(1.1875*stage.getHeight()-stage.getHeight())/2;anim=new Kinetic.Animation(function(frame){if(scale==endScale)frame.time=0,this.stop();else{var frameOfLayer=.1875*.1;scale+frameOfLayer>=endScale?scale=endScale:(scale+=frameOfLayer,scale=Math.round(1e3*scale)/1e3);var pos=layer.getAbsolutePosition(),frameOfStageX=pos.x-.1*widthScale,frameOfStageY=pos.y-.1*heightScale;layer.setScale(scale),layer.setAbsolutePosition(frameOfStageX,frameOfStageY)}},layer),anim.start()}}),$("#zoomOut").click(function(){if(!anim||!anim.isRunning()){var endScale=minScale>=scale-.1875?minScale:scale-.1875,widthScale=(1.1875*stage.getWidth()-stage.getWidth())/2,heightScale=(1.1875*stage.getHeight()-stage.getHeight())/2;anim=new Kinetic.Animation(function(frame){if(scale==endScale)frame.time=0,this.stop();else{var frameOfLayer=.1875*.1;endScale>=scale-frameOfLayer?scale=endScale:(scale-=frameOfLayer,scale=Math.round(1e3*scale)/1e3);var pos=layer.getAbsolutePosition(),frameOfStageX=pos.x+.1*widthScale,frameOfStageY=pos.y+.1*heightScale;layer.setScale(scale),layer.setAbsolutePosition(frameOfStageX,frameOfStageY)}},layer),anim.start()}}),$("#zoomSetting").click(function(){$(".ui.modal").modal({debug:!1,onApprove:function(){var index=Number($(".ui.dropdown").dropdown("get value"))-1;if(index>=0){for(var i=0;i<seatsConfig.length;i++){var seat=layer.find("#"+seatsConfig[i])[0];seat.setAttr("price",tickets[index].price),seat.setAttr("color",tickets[index].color),seat.setAttr("fill","rgba("+tickets[index].color+")"),seat.setAttr("name",tickets[index].name),seat.setAttr("sold",tickets[index].sold)}if(seatsConfig.length>0){for(var seats=layer.get(".highlight");seats.length>0;)seats[0].remove(),seats=layer.get(".highlight");seatsConfig.length=0}layer.batchDraw()}}}).modal("show")}),$("#zoomReset").click(function(){for(var i=0,len=seatsConfig.length;len>i;i++){var seat=layer.find("#"+seatsConfig[i])[0];seat.setAttr("name",seat.id),seat.setAttr("price",0),seat.setAttr("color",null),seat.setAttr("fill","rgba("+seatsUnconfigColor+")"),seat.setAttr("sold",!1)}if(seatsConfig.length>0){for(var seats=layer.get(".highlight");seats.length>0;)seats[0].remove(),seats=layer.get(".highlight");seatsConfig.length=0}layer.batchDraw()});$(document).on("mousedown",function(e){e.shiftKey&&layer.startDrag()}),$(document).on("mouseup",function(){layer.stopDrag()}),$(document).on("mousemove",function(e){e.shiftKey||(document.body.style.cursor="default",layer.stopDrag())}),$(document).on("keydown",function(e){e.shiftKey&&(document.body.style.cursor="all-scroll")}),$(document).on("keyup",function(){document.body.style.cursor="default"}),$(".ui .dropdown").dropdown({debug:!1,onChange:function(){}})});